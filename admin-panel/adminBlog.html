<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Panel</title>
    <link rel="stylesheet" href="styles.css">
    <style>
    /* Responsive grid for blogs */
    #blogs-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 24px;
    }
    #blogs-grid > div {
        flex: 1 1 calc(33.333% - 24px);
        max-width: calc(33.333% - 24px);
        min-width: 260px;
        box-sizing: border-box;
    }
    @media (max-width: 900px) {
        #blogs-grid > div {
            flex: 1 1 calc(50% - 24px);
            max-width: calc(50% - 24px);
        }
    }
    @media (max-width: 600px) {
        #blogs-grid {
            gap: 16px;
        }
        #blogs-grid > div {
            flex: 1 1 100%;
            max-width: 100%;
            min-width: 0;
        }
        .add-blog-container {
            margin-left: 0 !important;
            padding: 0 8px !important;
        }
        .sidebar {
            position: fixed;
            left: -256px;
            top: 0;
            width: 220px !important;
            transition: left 0.3s;
            z-index: 2000;
        }
        .sidebar.open {
            left: 0;
        }
        .sidebar-header {
            padding: 16px !important;
        }
        .sidebar-footer {
            padding: 12px !important;
        }
        .sidebar-toggle {
            display: block !important;
        }
    }
    @media (max-width: 600px) {
        .add-blog-form {
            padding: 18px 8px 16px 8px !important;
            max-width: 100% !important;
        }
        .add-blog-container {
            min-height: unset !important;
        }
    }
    .sidebar-toggle {
        display: none;
        position: fixed;
        top: 18px;
        left: 18px;
        background: #1f2937;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        font-size: 1.3rem;
        z-index: 2100;
        cursor: pointer;
    }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
</head>
<body style="margin:0; padding:0; background:#f3f4f6;">
    <div style="display:flex; min-height:100vh;">
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Open sidebar">‚ò∞</button>
    <nav id="sidebar" class="sidebar" style="width: 256px; background-color: #1f2937; color: white; flex-direction: column; position: fixed; top: 0; left: 0; height: 100vh; z-index: 100;">
            <div class="sidebar-header" style="padding: 24px; border-bottom: 1px solid #374151; text-align: center;">
                <a href="/admin-panel/dashboard.html" style="color: white; text-decoration: none;">
                    <h2 style="font-size: 24px; font-weight: bold; margin:0;">Admin Panel</h2>
                </a>
            </div>
            <ul class="sidebar-nav" style="flex: 1; padding: 16px; list-style: none;">
                <li style="margin-bottom: 8px;">
                    <a href="adminBlog.html" class="nav-link" onclick="showDashboardPage('add-blog')" style="display: flex; align-items: center; padding: 12px; color: white; text-decoration: none; border-radius: 8px; transition: background-color 0.2s; font-size: 16px;">
                        <span style="margin-right: 12px; font-size: 18px;">üìù</span> Add Blog
                    </a>
                </li>
                <li style="margin-bottom: 8px;">
                    <a href="adminProduct.html" class="nav-link" onclick="showDashboardPage('add-product')" style="display: flex; align-items: center; padding: 12px; color: white; text-decoration: none; border-radius: 8px; transition: background-color 0.2s; font-size: 16px;">
                        <span style="margin-right: 12px; font-size: 18px;">üì¶</span> Add Product
                    </a>
                </li>
                <li style="margin-bottom: 8px;">
                    <a href="adminContact.html" class="nav-link" onclick="showDashboardPage('contact-form')" style="display: flex; align-items: center; padding: 12px; color: white; text-decoration: none; border-radius: 8px; transition: background-color 0.2s; font-size: 16px;">
                        <span style="margin-right: 12px; font-size: 18px;">üìß</span> Contact Form
                    </a>
                </li>
            </ul>
            <div class="sidebar-footer" style="padding: 16px; border-top: 1px solid #374151;">
                <button class="logout-btn" style="width: 100%; display: flex; align-items: center; justify-content: center; padding: 12px; background-color: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; font-size: 16px;" onclick="logout()">
                    <span style="margin-right: 12px; font-size: 18px;">üö™</span> Logout
                </button>
            </div>
        </nav>
    <div class="add-blog-container" style="flex:1; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin-left: 256px; transition: margin-left 0.3s;">
            <form class="add-blog-form" style="background: #fff; padding: 32px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 500px;" onsubmit="handleAddBlog(event)">
                <h2 style="text-align: center; margin-bottom: 24px; font-size: 24px; font-weight: bold; color: #1f2937;">Add Blog</h2>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="blog-title" style="display: block; margin-bottom: 4px; font-weight: 500; color: #374151;">Title</label>
                    <input type="text" id="blog-title" name="title" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 16px;">
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="blog-content" style="display: block; margin-bottom: 4px; font-weight: 500; color: #374151;">Content</label>
                    <textarea id="blog-content" name="content" rows="5" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 16px; resize: vertical;"></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 24px;">
                    <label for="blog-author" style="display: block; margin-bottom: 4px; font-weight: 500; color: #374151;">Author</label>
                    <input type="text" id="blog-author" name="author" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 16px;">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; font-weight: 600; background-color: #2563eb; color: white; cursor: pointer;">Add Blog</button>
            </form>
        </div>
    </div>

    <!-- Your Blogs Section -->
    <div style="max-width: 1200px; margin: 40px auto 0 auto; padding: 0 24px; margin-left: 256px; transition: margin-left 0.3s;" id="blogs-section">
        <h2 style="font-size: 2rem; font-weight: bold; margin-bottom: 24px; color: #1f2937;">Your Blogs</h2>
        <div id="blogs-grid" style="display: flex; flex-wrap: wrap; gap: 24px;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
    <script src="script.js"></script>
    <script>
    async function handleAddBlog(event) {
        event.preventDefault();
        const title = document.getElementById('blog-title').value;
        const content = document.getElementById('blog-content').value;
        const author = document.getElementById('blog-author').value;
        try {
            const response = await fetch('http://localhost:5000/blog', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title, content, author })
            });
            const data = await response.json();
            if (response.ok) {
                Toastify({
                    text: data.message || 'Blog added successfully!',
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#10b981",
                    close: true
                }).showToast();
                event.target.reset();
                loadBlogs(); // Refresh blogs after adding
            } else {
                Toastify({
                    text: data.error || 'Failed to add blog.',
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#ef4444",
                    close: true
                }).showToast();
            }
        } catch (err) {
            Toastify({
                text: 'Network error. Please try again.',
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#ef4444",
                close: true
            }).showToast();
        }
    }

    // Fetch and display all blogs in a grid
    async function loadBlogs() {
        const grid = document.getElementById('blogs-grid');
        if (!grid) return;
        grid.innerHTML = '<div style="width:100%;text-align:center;padding:32px 0;color:#888;">Loading blogs...</div>';
        try {
            const response = await fetch('http://localhost:5000/blog');
            const blogs = await response.json();
            if (!Array.isArray(blogs) || blogs.length === 0) {
                grid.innerHTML = '<div style="width:100%;text-align:center;padding:32px 0;color:#888;">No blogs found.</div>';
                return;
            }
            grid.innerHTML = '';
            blogs.forEach((blog, i) => {
                const shortContent = blog.content.length > 120 ? blog.content.substring(0, 120) + '...' : blog.content;
                const card = document.createElement('div');
                card.style = 'background:#fff;flex:1 1 calc(33.333% - 24px);max-width:calc(33.333% - 24px);min-width:280px;box-shadow:0 2px 8px rgba(0,0,0,0.07);border-radius:10px;padding:24px;display:flex;flex-direction:column;gap:12px;position:relative;';
                console.log('Blog ID:', blog._id, 'Type:', typeof blog._id); // Debug log
                card.innerHTML = `
                    <h3 style="font-size:1.2rem;font-weight:600;color:#1f2937;margin-bottom:8px;">${blog.title}</h3>
                    <div style="color:#374151;font-size:0.98rem;">${shortContent}</div>
                    <div style="margin-top:auto;font-size:0.95rem;color:#555;">By: <b>${blog.author || 'Anonymous'}</b></div>
                    <div style="display:flex;gap:10px;margin-top:18px;">
                        <button onclick="editBlog('${blog._id}', '${encodeURIComponent(blog.title)}', '${encodeURIComponent(blog.content)}', '${encodeURIComponent(blog.author)}')" style="flex:1;padding:8px 0;background:#2563eb;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:0.98rem;font-weight:600;">Edit</button>
                        <button onclick="deleteBlog('${blog._id}')" style="flex:1;padding:8px 0;background:#dc2626;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:0.98rem;font-weight:600;">Delete</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        } catch (err) {
            grid.innerHTML = '<div style="width:100%;text-align:center;padding:32px 0;color:#e53e3e;">Error loading blogs.</div>';
        }
    }

    // Delete blog function
    async function deleteBlog(blogId) {
        console.log('Delete function called with ID:', blogId, 'Type:', typeof blogId); // Debug log
        
        if (!blogId || blogId === 'undefined') {
            Toastify({
                text: 'Invalid blog ID. Please refresh the page.',
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#ef4444",
                close: true
            }).showToast();
            return;
        }
        
        if (!confirm('Are you sure you want to delete this blog?')) return;
        
        try {
            console.log('Making DELETE request to:', `http://localhost:5000/blog/${blogId}`); // Debug log
            const response = await fetch(`http://localhost:5000/blog/${blogId}`, { method: 'DELETE' });
            console.log('Response status:', response.status); // Debug log
            
            if (response.status === 404) {
                Toastify({
                    text: 'Blog not found. It may have been already deleted.',
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#f59e0b",
                    close: true
                }).showToast();
                loadBlogs(); // Refresh to remove stale data
                return;
            }
            
            const data = await response.json();
            console.log('Response data:', data); // Debug log
            if (response.ok) {
                Toastify({
                    text: data.message || 'Blog deleted successfully!',
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#10b981",
                    close: true
                }).showToast();
                loadBlogs();
            } else {
                Toastify({
                    text: data.error || 'Failed to delete blog.',
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#ef4444",
                    close: true
                }).showToast();
            }
        } catch (err) {
            console.log('Delete error:', err); // Debug log
            Toastify({
                text: 'Network error. Please try again.',
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#ef4444",
                close: true
            }).showToast();
        }
    }

    // Edit blog function (opens modal)
    function editBlog(id, title, content, author) {
        if (!id || id === 'undefined') {
            Toastify({
                text: 'Invalid blog ID. Please refresh the page.',
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#ef4444",
                close: true
            }).showToast();
            return;
        }
        
        title = decodeURIComponent(title);
        content = decodeURIComponent(content);
        author = decodeURIComponent(author);
        let modal = document.getElementById('edit-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'edit-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(31,41,55,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;padding:36px 32px 28px 32px;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.18);width:100%;max-width:480px;position:relative;">
                    <button id="close-edit-modal" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5rem;color:#888;cursor:pointer;">&times;</button>
                    <h2 style="font-size:1.3rem;font-weight:700;margin-bottom:18px;color:#222;">Edit Blog</h2>
                    <form id="edit-blog-form">
                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-weight:600;margin-bottom:6px;">Title</label>
                            <input type="text" id="edit-title" value="" required style="width:100%;padding:10px 12px;border:1.2px solid #d1d5db;border-radius:5px;font-size:1rem;background:#f9fafb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-weight:600;margin-bottom:6px;">Content</label>
                            <textarea id="edit-content" rows="5" required style="width:100%;padding:10px 12px;border:1.2px solid #d1d5db;border-radius:5px;font-size:1rem;background:#f9fafb;resize:vertical;"></textarea>
                        </div>
                        <div style="margin-bottom:22px;">
                            <label style="display:block;font-weight:600;margin-bottom:6px;">Author</label>
                            <input type="text" id="edit-author" value="" required style="width:100%;padding:10px 12px;border:1.2px solid #d1d5db;border-radius:5px;font-size:1rem;background:#f9fafb;">
                        </div>
                        <button type="submit" style="width:100%;padding:12px 0;background:#2563eb;color:#fff;border:none;border-radius:5px;font-size:1.08rem;font-weight:700;cursor:pointer;">Save Changes</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        } else {
            modal.style.display = 'flex';
        }
        document.getElementById('edit-title').value = title;
        document.getElementById('edit-content').value = content;
        document.getElementById('edit-author').value = author;
        document.getElementById('close-edit-modal').onclick = () => { modal.style.display = 'none'; };
        document.getElementById('edit-blog-form').onsubmit = async function(e) {
            e.preventDefault();
            const newTitle = document.getElementById('edit-title').value;
            const newContent = document.getElementById('edit-content').value;
            const newAuthor = document.getElementById('edit-author').value;
            try {
                const response = await fetch(`http://localhost:5000/blog/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newTitle, content: newContent, author: newAuthor })
                });
                const data = await response.json();
                if (response.ok) {
                    Toastify({
                        text: data.message || 'Blog updated successfully!',
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "#10b981",
                        close: true
                    }).showToast();
                    modal.style.display = 'none';
                    loadBlogs();
                } else {
                    Toastify({
                        text: data.error || 'Failed to update blog.',
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "#ef4444",
                        close: true
                    }).showToast();
                }
            } catch (err) {
                Toastify({
                    text: 'Network error. Please try again.',
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#ef4444",
                    close: true
                }).showToast();
            }
        };
    }
    // Sidebar toggle for mobile
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('open');
        // Shift main content when sidebar is open
        const addBlogContainer = document.querySelector('.add-blog-container');
        const blogsSection = document.getElementById('blogs-section');
        if (sidebar.classList.contains('open')) {
            addBlogContainer.style.marginLeft = '220px';
            blogsSection.style.marginLeft = '220px';
        } else {
            addBlogContainer.style.marginLeft = '0';
            blogsSection.style.marginLeft = '0';
        }
    }
    document.getElementById('sidebarToggle').onclick = toggleSidebar;

    // Close sidebar on click outside (mobile)
    document.addEventListener('click', function(e) {
        const sidebar = document.getElementById('sidebar');
        if (window.innerWidth <= 600 && sidebar.classList.contains('open')) {
            if (!sidebar.contains(e.target) && e.target.id !== 'sidebarToggle') {
                sidebar.classList.remove('open');
                document.querySelector('.add-blog-container').style.marginLeft = '0';
                document.getElementById('blogs-section').style.marginLeft = '0';
            }
        }
    });

    // Check if user is logged in
    function checkAuth() {
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        if (!isLoggedIn || isLoggedIn !== 'true') {
            window.location.href = 'index.html';
        }
    }

    // Load blogs on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkAuth();
        loadBlogs();
    });
    </script>
</body>
</html>