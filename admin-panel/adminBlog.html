<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Blogs</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
    <style>
    /* Responsive grid for blogs */
    .blogs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 24px;
        margin-top: 30px;
    }
    
    .blog-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 24px;
        border: 1px solid #e5e7eb;
    }
    
    .blog-card h3 {
        margin: 0 0 12px 0;
        color: #1f2937;
        font-size: 18px;
        font-weight: 600;
    }
    
    .blog-card p {
        margin: 0 0 8px 0;
        color: #6b7280;
        line-height: 1.5;
    }
    
    .blog-card .meta {
        font-size: 14px;
        color: #9ca3af;
        margin-bottom: 16px;
    }
    
    .blog-card .actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-edit {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-delete {
        background: #ef4444;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    /* Ensure sidebar links are clickable */
    .sidebar .nav-link {
        cursor: pointer;
        pointer-events: auto;
    }
    
    .sidebar .nav-link:hover {
        background-color: #374151 !important;
    }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
</head>
<body style="margin:0; padding:0; background:#f3f4f6;">
    <!-- Mobile menu button -->
    <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleSidebar()" style="z-index: 1002;">
        ‚ò∞
    </button>
    
    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
    
    <div style="display:flex; min-height:100vh;">
    <nav id="sidebar" class="sidebar" style="width: 256px; background-color: #1f2937; color: white; flex-direction: column; position: fixed; top: 0; left: 0; height: 100vh; z-index: 1000;">
            <div class="sidebar-header" style="padding: 24px; border-bottom: 1px solid #374151; text-align: center;">
                <a href="/admin-panel/dashboard.html" style="color: white; text-decoration: none; position: relative; z-index: 1001;">
                    <h2 style="font-size: 24px; font-weight: bold; margin:0;">Admin Panel</h2>
                </a>
            </div>
            <ul class="sidebar-nav" style="flex: 1; padding: 16px; list-style: none; margin: 0;">
                <li style="margin-bottom: 8px;">
                    <a href="adminBlog.html" class="nav-link" style="display: flex; align-items: center; padding: 12px; color: white; text-decoration: none; border-radius: 8px; transition: background-color 0.2s; font-size: 16px; background-color: #374151; position: relative; z-index: 1001;">
                        <span style="margin-right: 12px; font-size: 18px;">üìù</span> Add Blog
                    </a>
                </li>
                <li style="margin-bottom: 8px;">
                    <a href="adminProduct.html" class="nav-link" style="display: flex; align-items: center; padding: 12px; color: white; text-decoration: none; border-radius: 8px; transition: background-color 0.2s; font-size: 16px; position: relative; z-index: 1001;">
                        <span style="margin-right: 12px; font-size: 18px;">üì¶</span> Add Product
                    </a>
                </li>
                <li style="margin-bottom: 8px;">
                    <a href="adminContact.html" class="nav-link" style="display: flex; align-items: center; padding: 12px; color: white; text-decoration: none; border-radius: 8px; transition: background-color 0.2s; font-size: 16px; position: relative; z-index: 1001;">
                        <span style="margin-right: 12px; font-size: 18px;">üìß</span> Contact Messages
                    </a>
                </li>
            </ul>
            <div class="sidebar-footer" style="padding: 16px; border-top: 1px solid #374151;">
                <!-- Session Timer -->
                <div id="session-timer" style="margin-bottom: 12px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; font-size: 12px; color: #3b82f6; text-align: center; display: none;">
                    <div style="font-weight: 500;">Session Time</div>
                    <div id="session-countdown">29:59</div>
                </div>
                
                <button class="logout-btn" style="width: 100%; display: flex; align-items: center; justify-content: center; padding: 12px; background-color: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; font-size: 16px; position: relative; z-index: 1001;" onclick="logout()">
                    <span style="margin-right: 12px; font-size: 18px;">üö™</span> Logout
                </button>
            </div>
        </nav>
        <div class="main-content mobile-padding" style="flex: 1; padding: 40px; margin-left: 256px; min-height: 100vh;">
            <!-- Add Blog Form Section -->
            <div>
                <h1 style="font-size: 32px; font-weight: bold; color: #1f2937; margin-bottom: 24px; text-align: center;">Add New Blog</h1>
                <form class="add-blog-form" onsubmit="handleAddBlog(event)" style="max-width: 600px; margin: 0 auto;">
                    <div id="blog-message" class="message" style="display: none; margin-bottom: 16px; padding: 12px; border-radius: 4px;"></div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label for="blog-title" style="display: block; margin-bottom: 4px; font-weight: 500; color: #374151;">Title</label>
                        <input type="text" id="blog-title" name="title" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 16px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label for="blog-content" style="display: block; margin-bottom: 4px; font-weight: 500; color: #374151;">Content</label>
                        <textarea id="blog-content" name="content" rows="6" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label for="blog-author" style="display: block; margin-bottom: 4px; font-weight: 500; color: #374151;">Author</label>
                        <input type="text" id="blog-author" name="author" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 16px;">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; font-weight: 600; background-color: #2563eb; color: white; cursor: pointer;">Add Blog</button>
                </form>
            </div>
            
            <!-- Blogs Grid Section -->
            <div >
                <h2 style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 24px; margin-top: 30px;">All Blogs</h2>
                <div id="blogs-grid" class="blogs-grid"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
    <script>
    async function handleAddBlog(event) {
        event.preventDefault();
        const title = document.getElementById('blog-title').value;
        const content = document.getElementById('blog-content').value;
        const author = document.getElementById('blog-author').value;
        
        // Show loading state
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Adding...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('http://localhost:5000/blog', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title, content, author })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Success
                showMessage('blog-message', data.message || 'Blog added successfully!', 'success');
                showToast('Blog added successfully!', 'success');
                
                // Clear form
                document.getElementById('blog-title').value = '';
                document.getElementById('blog-content').value = '';
                document.getElementById('blog-author').value = '';
                
                // Reload blogs
                loadBlogs();
                
            } else {
                // Error
                showMessage('blog-message', data.error || 'Failed to add blog', 'error');
                showToast(data.error || 'Failed to add blog', 'error');
            }
            
        } catch (error) {
            console.error('Add blog error:', error);
            showMessage('blog-message', 'Network error. Please try again.', 'error');
            showToast('Network error. Please try again.', 'error');
        } finally {
            // Reset button state
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    // Utility functions
    function showMessage(elementId, message, type) {
        const messageDiv = document.getElementById(elementId);
        messageDiv.textContent = message;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = 'block';
        
        if (type === 'success') {
            messageDiv.style.backgroundColor = '#d1fae5';
            messageDiv.style.color = '#065f46';
            messageDiv.style.border = '1px solid #a7f3d0';
        } else {
            messageDiv.style.backgroundColor = '#fee2e2';
            messageDiv.style.color = '#991b1b';
            messageDiv.style.border = '1px solid #fca5a5';
        }
    }

    function showToast(message, type) {
        Toastify({
            text: message,
            duration: 3000,
            close: true,
            gravity: "top",
            position: "center",
            backgroundColor: type === 'success' ? "#10b981" : "#ef4444",
        }).showToast();
    }

    // Fetch and display all blogs in a grid
    async function loadBlogs() {
        const grid = document.getElementById('blogs-grid');
        if (!grid) return;
        grid.innerHTML = '<div style="width:100%;text-align:center;padding:32px 0;color:#888;">Loading blogs...</div>';
        try {
            const response = await fetch('http://localhost:5000/blog');
            const blogs = await response.json();
            if (!Array.isArray(blogs) || blogs.length === 0) {
                grid.innerHTML = '<div style="width:100%;text-align:center;padding:32px 0;color:#888;">No blogs found.</div>';
                return;
            }
            grid.innerHTML = '';
            blogs.forEach((blog, i) => {
                const shortContent = blog.content.length > 120 ? blog.content.substring(0, 120) + '...' : blog.content;
                const card = document.createElement('div');
                card.className = 'blog-card';
                console.log('Blog ID:', blog._id, 'Type:', typeof blog._id); // Debug log
                card.innerHTML = `
                    <h3>${blog.title}</h3>
                    <p>${shortContent}</p>
                    <div class="meta">By: <strong>${blog.author || 'Anonymous'}</strong></div>
                    <div class="actions">
                        <button class="btn-edit" onclick="editBlog('${blog._id}', '${encodeURIComponent(blog.title)}', '${encodeURIComponent(blog.content)}', '${encodeURIComponent(blog.author)}')">Edit</button>
                        <button class="btn-delete" onclick="deleteBlog('${blog._id}')">Delete</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        } catch (err) {
            grid.innerHTML = '<div style="width:100%;text-align:center;padding:32px 0;color:#e53e3e;">Error loading blogs.</div>';
        }
    }

    // Delete blog function
    async function deleteBlog(blogId) {
        console.log('Delete function called with ID:', blogId, 'Type:', typeof blogId); // Debug log
        
        if (!blogId || blogId === 'undefined') {
            Toastify({
                text: 'Invalid blog ID. Please refresh the page.',
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#ef4444",
                close: true
            }).showToast();
            return;
        }
        
        if (!confirm('Are you sure you want to delete this blog?')) return;
        
        try {
            console.log('Making DELETE request to:', `http://localhost:5000/blog/${blogId}`); // Debug log
            const response = await fetch(`http://localhost:5000/blog/${blogId}`, { method: 'DELETE' });
            console.log('Response status:', response.status); // Debug log
            
            if (response.status === 404) {
                Toastify({
                    text: 'Blog not found. It may have been already deleted.',
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#f59e0b",
                    close: true
                }).showToast();
                loadBlogs(); // Refresh to remove stale data
                return;
            }
            
            const data = await response.json();
            console.log('Response data:', data); // Debug log
            if (response.ok) {
                Toastify({
                    text: data.message || 'Blog deleted successfully!',
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#10b981",
                    close: true
                }).showToast();
                loadBlogs();
            } else {
                Toastify({
                    text: data.error || 'Failed to delete blog.',
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#ef4444",
                    close: true
                }).showToast();
            }
        } catch (err) {
            console.log('Delete error:', err); // Debug log
            Toastify({
                text: 'Network error. Please try again.',
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#ef4444",
                close: true
            }).showToast();
        }
    }

    // Edit blog function (opens modal)
    function editBlog(id, title, content, author) {
        if (!id || id === 'undefined') {
            Toastify({
                text: 'Invalid blog ID. Please refresh the page.',
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#ef4444",
                close: true
            }).showToast();
            return;
        }
        
        title = decodeURIComponent(title);
        content = decodeURIComponent(content);
        author = decodeURIComponent(author);
        let modal = document.getElementById('edit-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'edit-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(31,41,55,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;padding:36px 32px 28px 32px;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.18);width:100%;max-width:480px;position:relative;">
                    <button id="close-edit-modal" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5rem;color:#888;cursor:pointer;">&times;</button>
                    <h2 style="font-size:1.3rem;font-weight:700;margin-bottom:18px;color:#222;">Edit Blog</h2>
                    <form id="edit-blog-form">
                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-weight:600;margin-bottom:6px;">Title</label>
                            <input type="text" id="edit-title" value="" required style="width:100%;padding:10px 12px;border:1.2px solid #d1d5db;border-radius:5px;font-size:1rem;background:#f9fafb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-weight:600;margin-bottom:6px;">Content</label>
                            <textarea id="edit-content" rows="5" required style="width:100%;padding:10px 12px;border:1.2px solid #d1d5db;border-radius:5px;font-size:1rem;background:#f9fafb;resize:vertical;"></textarea>
                        </div>
                        <div style="margin-bottom:22px;">
                            <label style="display:block;font-weight:600;margin-bottom:6px;">Author</label>
                            <input type="text" id="edit-author" value="" required style="width:100%;padding:10px 12px;border:1.2px solid #d1d5db;border-radius:5px;font-size:1rem;background:#f9fafb;">
                        </div>
                        <button type="submit" style="width:100%;padding:12px 0;background:#2563eb;color:#fff;border:none;border-radius:5px;font-size:1.08rem;font-weight:700;cursor:pointer;">Save Changes</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        } else {
            modal.style.display = 'flex';
        }
        document.getElementById('edit-title').value = title;
        document.getElementById('edit-content').value = content;
        document.getElementById('edit-author').value = author;
        document.getElementById('close-edit-modal').onclick = () => { modal.style.display = 'none'; };
        document.getElementById('edit-blog-form').onsubmit = async function(e) {
            e.preventDefault();
            const newTitle = document.getElementById('edit-title').value;
            const newContent = document.getElementById('edit-content').value;
            const newAuthor = document.getElementById('edit-author').value;
            try {
                const response = await fetch(`http://localhost:5000/blog/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newTitle, content: newContent, author: newAuthor })
                });
                const data = await response.json();
                if (response.ok) {
                    Toastify({
                        text: data.message || 'Blog updated successfully!',
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "#10b981",
                        close: true
                    }).showToast();
                    modal.style.display = 'none';
                    loadBlogs();
                } else {
                    Toastify({
                        text: data.error || 'Failed to update blog.',
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "#ef4444",
                        close: true
                    }).showToast();
                }
            } catch (err) {
                Toastify({
                    text: 'Network error. Please try again.',
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#ef4444",
                    close: true
                }).showToast();
            }
        };
    }

    // Check if user is logged in
    function checkAuth() {
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        if (!isLoggedIn || isLoggedIn !== 'true') {
            window.location.href = 'index.html';
        }
    }

    function logout() {
        localStorage.removeItem('isLoggedIn');
        window.location.href = 'index.html';
    }

    // Mobile sidebar functions
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
    }

    function closeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
    }

    // Load blogs on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkAuth();
        loadBlogs();

        // Debug function to test sidebar clicks
        console.log('Page loaded, sidebar should be clickable');
        
        // Test if sidebar elements are properly accessible
        const sidebarLinks = document.querySelectorAll('.sidebar .nav-link');
        console.log('Found sidebar links:', sidebarLinks.length);
        
        sidebarLinks.forEach((link, index) => {
            console.log(`Link ${index + 1}:`, link.href);
        });

        // Close sidebar when clicking on navigation links (mobile)
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                console.log('Nav link clicked:', this.href);
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
            });
        });

        // Close sidebar on window resize if desktop
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeSidebar();
            }
        });
    });
    </script>
</body>
</html>